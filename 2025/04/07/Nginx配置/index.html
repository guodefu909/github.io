<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"guodefu909.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="全局配置123456789101112131415# 全局配置user  nginx;  # 指定 Nginx 工作进程的用户worker_processes  auto;  # 根据可用 CPU 核心数自动设置工作进程数# 最大打开文件描述符worker_rlimit_nofile  1024;          error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log warn;">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx配置">
<meta property="og:url" content="https://guodefu909.github.io/2025/04/07/Nginx%E9%85%8D%E7%BD%AE/index.html">
<meta property="og:site_name" content="郭德福的博客">
<meta property="og:description" content="全局配置123456789101112131415# 全局配置user  nginx;  # 指定 Nginx 工作进程的用户worker_processes  auto;  # 根据可用 CPU 核心数自动设置工作进程数# 最大打开文件描述符worker_rlimit_nofile  1024;          error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log warn;">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-04-07T14:53:17.000Z">
<meta property="article:modified_time" content="2025-04-07T15:07:34.272Z">
<meta property="article:author" content="guodefu909">
<meta property="article:tag" content="郭德福, 博客, guodefu909">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://guodefu909.github.io/2025/04/07/Nginx%E9%85%8D%E7%BD%AE/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://guodefu909.github.io/2025/04/07/Nginx%E9%85%8D%E7%BD%AE/","path":"2025/04/07/Nginx配置/","title":"Nginx配置"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Nginx配置 | 郭德福的博客</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">郭德福的博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="nav-number">1.</span> <span class="nav-text">全局配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http-%E9%85%8D%E7%BD%AE"><span class="nav-number">2.</span> <span class="nav-text">http 配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">3.</span> <span class="nav-text">负载均衡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#server-%E9%85%8D%E7%BD%AE"><span class="nav-number">4.</span> <span class="nav-text">server 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2%E9%85%8D%E7%BD%AE"><span class="nav-number">4.1.</span> <span class="nav-text">错误页面配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-number">4.2.</span> <span class="nav-text">重定向</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTPS-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">4.3.</span> <span class="nav-text">HTTPS 服务器配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#location"><span class="nav-number">5.</span> <span class="nav-text">location</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E5%8C%B9%E9%85%8D"><span class="nav-number">5.1.</span> <span class="nav-text">路径匹配</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9B%E7%A7%8D%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99"><span class="nav-number">5.1.1.</span> <span class="nav-text">四种匹配规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">5.1.2.</span> <span class="nav-text">优先级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8C%B9%E9%85%8D%E7%A4%BA%E4%BE%8B"><span class="nav-number">5.1.3.</span> <span class="nav-text">匹配示例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%B2%BE%E7%A1%AE%E5%8C%B9%E9%85%8D"><span class="nav-number">5.1.3.1.</span> <span class="nav-text">精确匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BC%98%E5%85%88%E5%89%8D%E7%BC%80%E5%8C%B9%E9%85%8D"><span class="nav-number">5.1.3.2.</span> <span class="nav-text">优先前缀匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D"><span class="nav-number">5.1.3.3.</span> <span class="nav-text">正则匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E5%89%8D%E7%BC%80%E5%8C%B9%E9%85%8D"><span class="nav-number">5.1.3.4.</span> <span class="nav-text">普通前缀匹配</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86-proxy-pass"><span class="nav-number">5.2.</span> <span class="nav-text">反向代理 proxy_pass</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%A1%B9%E8%A7%A3%E9%87%8A"><span class="nav-number">5.2.1.</span> <span class="nav-text">配置项解释</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#URL-%E6%88%AA%E5%8F%96"><span class="nav-number">5.2.2.</span> <span class="nav-text">URL 截取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E5%9C%BA%E6%99%AF"><span class="nav-number">5.2.3.</span> <span class="nav-text">示例场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%90%E5%88%B6%E8%AE%BF%E9%97%AE"><span class="nav-number">5.3.</span> <span class="nav-text">限制访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%90%E5%88%B6%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%A4%A7%E5%B0%8F"><span class="nav-number">5.4.</span> <span class="nav-text">限制上传文件的类型和大小</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%98%E9%87%8F"><span class="nav-number">6.</span> <span class="nav-text">变量</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">guodefu909</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://guodefu909.github.io/2025/04/07/Nginx%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guodefu909">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="郭德福的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Nginx配置 | 郭德福的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nginx配置
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-04-07 22:53:17 / 修改时间：23:07:34" itemprop="dateCreated datePublished" datetime="2025-04-07T22:53:17+08:00">2025-04-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"><span class="attribute">user</span>  nginx;  <span class="comment"># 指定 Nginx 工作进程的用户</span></span><br><span class="line"><span class="attribute">worker_processes</span>  auto;  <span class="comment"># 根据可用 CPU 核心数自动设置工作进程数</span></span><br><span class="line"><span class="comment"># 最大打开文件描述符</span></span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span>  <span class="number">1024</span>;          </span><br><span class="line"></span><br><span class="line"><span class="attribute">error_log</span>  /var/log/nginx/<span class="literal">error</span>.log <span class="literal">warn</span>;  <span class="comment"># 错误日志文件及日志级别</span></span><br><span class="line"><span class="attribute">pid</span>        /var/run/nginx.pid;  <span class="comment"># PID 文件的位置</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;  <span class="comment"># 每个工作进程允许的最大连接数</span></span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;  <span class="comment"># 启用多重接收,在高负载的服务器上使用</span></span><br><span class="line">    <span class="comment"># 使用 epoll 模型（Linux 特有），相对于传统的 `select` 和 `poll` 更高效</span></span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="http-配置"><a href="#http-配置" class="headerlink" title="http 配置"></a>http 配置</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">server_tokens</span>  <span class="literal">off</span>;  <span class="comment"># 隐藏 Nginx 版本</span></span><br><span class="line">    <span class="attribute">include</span>       /etc/nginx/mime.types;  <span class="comment"># 文件扩展名与文件类型映射表</span></span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;  <span class="comment"># 默认文件类型</span></span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自定义日志格式</span></span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 访问日志文件及使用的日志格式</span></span><br><span class="line">    <span class="attribute">access_log</span>  /var/log/nginx/access.log  main;  </span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>                <span class="literal">on</span>;  <span class="comment"># 启用高效文件传输模式</span></span><br><span class="line">    <span class="attribute">tcp_nopush</span>                <span class="literal">on</span>;  <span class="comment"># 减少网络报文段的数量</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>        <span class="number">65</span>;  <span class="comment"># 长连接超时时间</span></span><br><span class="line">    <span class="attribute">tcp_nodelay</span>                <span class="literal">on</span>;  <span class="comment"># 启用 TCP_NODELAY</span></span><br><span class="line">    <span class="attribute">types_hash_max_size</span>        <span class="number">2048</span>;  <span class="comment"># 类型哈希表的最大大小</span></span><br><span class="line">    <span class="attribute">client_body_timeout</span>        <span class="number">12</span>; </span><br><span class="line">    <span class="attribute">client_header_timeout</span>    <span class="number">12</span>;</span><br><span class="line">    <span class="attribute">send_timeout</span>            <span class="number">10</span>; </span><br><span class="line">    <span class="attribute">keepalive_requests</span>        <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 限制请求的速率（防止 DDoS 攻击） </span></span><br><span class="line">    <span class="attribute">limit_req_zone</span> <span class="variable">$binary_remote_addr</span> zone=mylimit:<span class="number">10m</span> rate=10r/s;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 压缩传输内容   </span></span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>;  <span class="comment"># 启用 gzip 压缩</span></span><br><span class="line">    <span class="attribute">gzip_disable</span> <span class="string">&quot;msie6&quot;</span>;  <span class="comment"># 禁用旧版 IE 的 gzip 压缩</span></span><br><span class="line">    <span class="attribute">gzip_vary</span> <span class="literal">on</span>;  <span class="comment"># 为代理和缓存服务器设置 Vary 头</span></span><br><span class="line">    <span class="attribute">gzip_proxied</span> any;  <span class="comment"># 允许所有代理请求进行 gzip 压缩</span></span><br><span class="line">    <span class="attribute">gzip_comp_level</span> <span class="number">6</span>;  <span class="comment"># 压缩级别（1-9，数字越大压缩率越高）</span></span><br><span class="line">    <span class="attribute">gzip_buffers</span> <span class="number">16</span> <span class="number">8k</span>;  <span class="comment"># 压缩缓冲区</span></span><br><span class="line">    <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;  <span class="comment"># 使用 HTTP/1.1 进行 gzip 压缩</span></span><br><span class="line">    <span class="comment"># 压缩类型</span></span><br><span class="line">    <span class="attribute">gzip_types</span> text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;  <span class="comment"># 包含额外的配置文件    </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><ul>
<li><strong>轮询（默认）</strong>：依次将请求分发给每个服务器。</li>
<li><strong>权重</strong>：根据服务器的权重进行请求分配，权重越高，分配的请求越多。</li>
<li><strong>IP 哈希</strong>：根据客户端 IP 进行哈希计算，保证同一个客户端的请求总是转发到同一个服务器。</li>
<li><strong>最少连接数</strong>：将请求分配给当前连接数最少的服务器。</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 负载均衡配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 轮询</span></span><br><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend3.example.com;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 其他选项 </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设置失败尝试次数和超时时间</span></span><br><span class="line">    max_fails=3 fail_timeout=30s; </span><br><span class="line">    <span class="comment"># 设置保持活动的最大连接数</span></span><br><span class="line">    <span class="attribute">keepalive</span> <span class="number">32</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 权重</span></span><br><span class="line"><span class="section">upstream</span> backend &#123; </span><br><span class="line">    <span class="comment"># 定义后端服务器及权重</span></span><br><span class="line">    <span class="attribute">server</span> backend1.example.com weight=<span class="number">3</span>; </span><br><span class="line">    <span class="attribute">server</span> backend2.example.com weight=<span class="number">2</span>; </span><br><span class="line">    <span class="attribute">server</span> backend3.example.com weight=<span class="number">1</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># IP 哈希</span></span><br><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    ip_hash;  <span class="comment"># 启用 IP 哈希负载均衡算法</span></span><br><span class="line">    <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend3.example.com;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最少连接数</span></span><br><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    least_conn; <span class="comment"># 启用最少连接数负载均衡算法</span></span><br><span class="line">    <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend3.example.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="server-配置"><a href="#server-配置" class="headerlink" title="server 配置"></a>server 配置</h2><h3 id="错误页面配置"><a href="#错误页面配置" class="headerlink" title="错误页面配置"></a>错误页面配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123; </span><br><span class="line">    <span class="comment"># 错误页面配置 </span></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html; <span class="comment"># 404 错误页面 </span></span><br><span class="line">    <span class="section">location</span> = /<span class="number">404</span>.html &#123; </span><br><span class="line">        <span class="attribute">root</span> /usr/share/nginx/html; <span class="comment"># 404 错误页面路径 </span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html; <span class="comment"># 其他错误页面 </span></span><br><span class="line">    <span class="section">location</span> = /50x.html &#123; </span><br><span class="line">        <span class="attribute">root</span> /usr/share/nginx/html; <span class="comment"># 错误页面路径 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123; </span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>; <span class="comment"># 监听 80 端口 </span></span><br><span class="line">    <span class="attribute">server_name</span> example.com; <span class="comment"># 服务器名称 </span></span><br><span class="line">    <span class="comment"># 将所有 HTTP 请求重定向到 HTTPS </span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>; </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将请求重定向到新的路径</span></span><br><span class="line">    <span class="section">location</span> /oldpath/ &#123; </span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> /newpath/;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="HTTPS-服务器配置"><a href="#HTTPS-服务器配置" class="headerlink" title="HTTPS 服务器配置"></a>HTTPS 服务器配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123; </span><br><span class="line">    <span class="comment"># 监听 443 端口，启用 SSL 和 HTTP/2 </span></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2; </span><br><span class="line">    <span class="comment"># 服务器名称 </span></span><br><span class="line">    <span class="attribute">server_name</span> example.com; </span><br><span class="line">    <span class="comment"># SSL 证书文件 </span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/example.com.crt; </span><br><span class="line">    <span class="comment"># SSL 证书密钥文件 </span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/example.com.key;</span><br><span class="line">    <span class="comment"># 启用的 SSL 协议  </span></span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>; </span><br><span class="line">    <span class="comment"># 加密套件 </span></span><br><span class="line">    <span class="attribute">ssl_ciphers</span> <span class="string">&#x27;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384&#x27;</span>; </span><br><span class="line">    <span class="comment"># 优先使用服务器的加密套件 </span></span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>; </span><br><span class="line">    <span class="comment"># SSL 会话缓存 </span></span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>; </span><br><span class="line">    <span class="comment"># SSL 会话超时时间 </span></span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>; </span><br><span class="line">    <span class="comment"># SSL Stapling 可以提高 SSL/TLS 握手过程中的性能和安全性。</span></span><br><span class="line">    <span class="comment"># 它通过缓存和传递证书的状态信息，减少了每次连接到认证机构的需要。</span></span><br><span class="line">    <span class="attribute">ssl_stapling</span> <span class="literal">on</span>; </span><br><span class="line">    <span class="comment"># 启用 SSL Stapling 响应的验证，确保证书颁发机构真实性和有效性。</span></span><br><span class="line">    <span class="attribute">ssl_stapling_verify</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="comment"># 用于指定包含受信任的 CA 证书的文件，从证书供应商获得</span></span><br><span class="line">    <span class="comment"># 如果启用了 SSL Stapling 并且希望对 OCSP 响应进行验证，那么这个指令是必要的</span></span><br><span class="line">    <span class="attribute">ssl_trusted_certificate</span> /etc/nginx/ssl/example.com_chain.crt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 安全头部 </span></span><br><span class="line">    <span class="comment"># 防止网页被嵌入到其他网站的 `&lt;iframe&gt;` 中</span></span><br><span class="line">    <span class="comment"># DENY：禁止所有来源的嵌入。</span></span><br><span class="line">    <span class="comment"># SAMEORIGIN：允许同一域名的嵌入。</span></span><br><span class="line">    <span class="comment"># ALLOW-FROM uri：允许指定的来源嵌入</span></span><br><span class="line">    <span class="attribute">add_header</span> X-Frame-Options DENY; </span><br><span class="line">    <span class="comment"># 防止浏览器进行 MIME 类型猜测，防止 MIME 类型混淆攻击</span></span><br><span class="line">    <span class="attribute">add_header</span> X-Content-Type-Options nosniff; </span><br><span class="line">    <span class="comment"># 启用浏览器的 XSS 过滤器，并在检测到攻击时阻止页面加载。</span></span><br><span class="line">    <span class="attribute">add_header</span> X-XSS-Protection <span class="string">&quot;1; mode=block&quot;</span>; </span><br><span class="line">    <span class="comment"># 强制浏览器通过 HTTPS 访问网站，防止中间人攻击。</span></span><br><span class="line">    <span class="comment"># max-age：设置浏览器缓存 HSTS 规则的时间（秒）。31536000代表1年。</span></span><br><span class="line">    <span class="comment"># includeSubDomains：应用 HSTS 规则到所有子域。</span></span><br><span class="line">    <span class="comment"># preload：表明网站支持 HSTS 预加载列表（需要向 Chrome 提交）。</span></span><br><span class="line">    <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br></pre></td></tr></table></figure>


<h2 id="location"><a href="#location" class="headerlink" title="location"></a>location</h2><h3 id="路径匹配"><a href="#路径匹配" class="headerlink" title="路径匹配"></a>路径匹配</h3><h4 id="四种匹配规则"><a href="#四种匹配规则" class="headerlink" title="四种匹配规则"></a>四种匹配规则</h4><ol>
<li><strong>精确匹配</strong>：使用 <code>=</code> 修饰符，只匹配完全相同的 URI。</li>
<li><strong>优先前缀匹配</strong>：使用 <code>^~</code> 修饰符，匹配以指定路径开头的请求。</li>
<li><strong>正则匹配</strong>：使用 <code>~</code> 或 <code>~*</code> 修饰符，<code>~</code> 表示区分大小写，<code>~*</code> 表示不区分大小写。 </li>
<li><strong>普通前缀匹配</strong>：使用 <code>/path/</code> 形式，匹配以指定路径开头的请求。</li>
</ol>
<h4 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h4><p><strong>精确匹配</strong> (<code>=</code>) &gt; <strong>优先前缀匹配</strong> (<code>^~</code>) &gt; <strong>正则匹配</strong> (<code>~</code>, <code>~*</code>) &gt; <strong>普通前缀匹配</strong></p>
<h4 id="匹配示例"><a href="#匹配示例" class="headerlink" title="匹配示例"></a>匹配示例</h4><h5 id="精确匹配"><a href="#精确匹配" class="headerlink" title="精确匹配"></a>精确匹配</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> = /50x.html &#123; </span><br><span class="line">    <span class="attribute">root</span> /usr/share/nginx/html; <span class="comment"># 错误页面路径 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="优先前缀匹配"><a href="#优先前缀匹配" class="headerlink" title="优先前缀匹配"></a>优先前缀匹配</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span><span class="regexp"> ^~</span> /static/ &#123; </span><br><span class="line">    <span class="attribute">root</span> /data/static; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="正则匹配"><a href="#正则匹配" class="headerlink" title="正则匹配"></a>正则匹配</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> <span class="regexp">~ ^/api/(.*)$</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://spring_cloud_gateway/<span class="variable">$1</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="普通前缀匹配"><a href="#普通前缀匹配" class="headerlink" title="普通前缀匹配"></a>普通前缀匹配</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /proxy/ &#123; </span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8080;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="反向代理-proxy-pass"><a href="#反向代理-proxy-pass" class="headerlink" title="反向代理 proxy_pass"></a>反向代理 proxy_pass</h3><h4 id="配置项解释"><a href="#配置项解释" class="headerlink" title="配置项解释"></a>配置项解释</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向代理</span></span><br><span class="line"><span class="section">location</span><span class="regexp"> ^~</span> /api/ &#123; </span><br><span class="line">    <span class="comment"># 常用</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 代理到后端服务器 </span></span><br><span class="line">    <span class="attribute">proxy_pass</span> http://spring_cloud_gateway/; </span><br><span class="line">    <span class="comment"># 传递客户端请求中的原始主机名</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>; </span><br><span class="line">    <span class="comment"># 传递客户端的真实 IP</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>; </span><br><span class="line">    <span class="comment"># 传递客户端 IP 及所有代理服务器的 IP</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="comment"># 传递客户端请求使用的协议</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 不常用</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 代理重定向</span></span><br><span class="line">    <span class="comment"># 修改后端服务器响应中的 Location 和 Refresh 头部以适应前端</span></span><br><span class="line">    <span class="comment"># 例如，后端服务器返回 http://backend_server/some_path，而你希望客户端访问 http://example.com/some_path</span></span><br><span class="line">    <span class="attribute">proxy_redirect</span> http://backend_server http://example.com;</span><br><span class="line">    <span class="comment"># 修改传递给后端服务器的请求体（一般不需要配置）</span></span><br><span class="line">    <span class="attribute">proxy_set_body</span> <span class="variable">$request_body</span>;</span><br><span class="line">    <span class="comment"># 启用或禁用代理缓冲（默认启用）</span></span><br><span class="line">    <span class="comment"># 如果后端服务器响应较大且希望尽快开始传输给客户端，可以禁用缓冲</span></span><br><span class="line">    <span class="attribute">proxy_buffering</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="comment"># 设置从后端服务器接收响应的超时时间</span></span><br><span class="line">    <span class="comment"># 根据后端服务响应时间配置，一般设置为30秒到60秒</span></span><br><span class="line">    <span class="attribute">proxy_read_timeout</span> <span class="number">10s</span>;</span><br><span class="line">    <span class="comment"># 设置与后端服务器建立连接的超时时间</span></span><br><span class="line">    <span class="comment"># 一般设置为30秒到60秒，具体根据网络延迟和后端连接时间确定</span></span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span> <span class="number">5s</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="URL-截取"><a href="#URL-截取" class="headerlink" title="URL 截取"></a>URL 截取</h4><p>反向代理 的 URL 是否截取，主要看这个 URL 是否是 基础 URL<br>基础 URL 不会截取；非基础 URL 会被截取（如带有<code>/</code>或路径）<br>基础 URL 的结构如下：协议:&#x2F;&#x2F;主机名[:端口号]</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础 URL 不会截取</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># http://example.com/t1/doc ==&gt; http://servers/t1/doc</span></span><br><span class="line"><span class="section">location</span> /t1/ &#123; <span class="attribute">proxy_pass</span> http://servers; &#125;</span><br><span class="line"><span class="comment"># http://example.com/t2/doc ==&gt; http://servers/t2/doc</span></span><br><span class="line"><span class="section">location</span> /t2  &#123; <span class="attribute">proxy_pass</span> http://servers; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 非基础 URL 会被截取</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># http://example.com/t3/doc ==&gt; http://servers/doc</span></span><br><span class="line"><span class="section">location</span> /t3/ &#123; <span class="attribute">proxy_pass</span> http://servers/; &#125;</span><br><span class="line"><span class="comment"># http://example.com/t4/doc ==&gt; http://servers/doc</span></span><br><span class="line"><span class="comment"># Nginx 会智能地处理路径拼接，避免出现双斜杠</span></span><br><span class="line"><span class="section">location</span> /t4  &#123; <span class="attribute">proxy_pass</span> http://servers/; &#125;</span><br><span class="line"><span class="comment"># http://example.com/t5/doc ==&gt; http://servers/test/doc</span></span><br><span class="line"><span class="section">location</span> /t5/ &#123; <span class="attribute">proxy_pass</span> http://servers/test/; &#125;</span><br><span class="line"><span class="comment"># http://example.com/t6/doc ==&gt; http://servers/test/doc</span></span><br><span class="line"><span class="section">location</span> /t6  &#123; <span class="attribute">proxy_pass</span> http://servers/test; &#125;</span><br><span class="line"><span class="comment"># http://example.com/t7/doc ==&gt; http://servers/test/doc</span></span><br><span class="line"><span class="comment"># Nginx 会智能地处理路径拼接，避免出现双斜杠</span></span><br><span class="line"><span class="section">location</span> /t7  &#123; <span class="attribute">proxy_pass</span> http://servers/test/; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 错误配置</span></span><br><span class="line"><span class="comment"># 为了确保 Nginx 在转发请求时能够正确处理路径，建议在 proxy_pass URL 的末尾添加一个斜杠</span></span><br><span class="line"><span class="comment"># http://example.com/t8/doc ==&gt; http://servers/testdoc</span></span><br><span class="line"><span class="section">location</span> /t8/ &#123; <span class="attribute">proxy_pass</span> http://servers/test; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正则表达式截取</span></span><br><span class="line"><span class="comment"># http://example.com/t9/doc ==&gt; http://servers/testdoc</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ ^/t9/(.*)$</span> &#123; <span class="attribute">proxy_pass</span> http://servers/<span class="variable">$1</span>; &#125;</span><br></pre></td></tr></table></figure>



<h4 id="示例场景"><a href="#示例场景" class="headerlink" title="示例场景"></a>示例场景</h4><p>假设有一个客户端 <code>192.168.1.100</code><br>通过 Nginx 代理 <code>192.168.1.200</code><br>访问 Spring Cloud Gateway</p>
<ul>
<li><p>客户端请求：<code>https://example.com/api/resource</code></p>
</li>
<li><p>nginx配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向代理</span></span><br><span class="line"><span class="section">location</span><span class="regexp"> ^~</span> /api/ &#123; </span><br><span class="line">    <span class="attribute">proxy_pass</span> http://spring_cloud_gateway/;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Nginx转发请求：<code>https://spring_cloud_gateway/resource</code></p>
</li>
<li><p>后端服务器接收到的请求头如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>example.com</span><br><span class="line"><span class="attribute">X-Real-IP</span><span class="punctuation">: </span>192.168.1.100</span><br><span class="line"><span class="attribute">X-Forwarded-For</span><span class="punctuation">: </span>192.168.1.100, 192.168.1.200</span><br><span class="line"><span class="attribute">X-Forwarded-Proto</span><span class="punctuation">: </span>https</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="限制访问"><a href="#限制访问" class="headerlink" title="限制访问"></a>限制访问</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="section">location</span> /admin/ &#123; </span><br><span class="line">        <span class="attribute">allow</span> <span class="number">192.168.1.0</span>/<span class="number">24</span>; <span class="comment"># 允许特定网段的 IP 访问 </span></span><br><span class="line">        <span class="attribute">deny</span> all; <span class="comment"># 拒绝所有其他访问 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="限制上传文件的类型和大小"><a href="#限制上传文件的类型和大小" class="headerlink" title="限制上传文件的类型和大小"></a>限制上传文件的类型和大小</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义允许上传的 MIME 类型</span></span><br><span class="line">    <span class="attribute">map</span> <span class="variable">$http_content_type</span> <span class="variable">$allowed_type</span> &#123;</span><br><span class="line">        <span class="attribute">default</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 图片</span></span><br><span class="line">        &quot;image/jpeg&quot; 1;</span><br><span class="line">        &quot;image/png&quot; 1;</span><br><span class="line">        &quot;image/gif&quot; 1;</span><br><span class="line">        &quot;image/bmp&quot; 1;</span><br><span class="line">        &quot;image/webp&quot; 1;</span><br><span class="line">        &quot;image/svg+xml&quot; 1;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 文档</span></span><br><span class="line">        &quot;application/pdf&quot; 1;</span><br><span class="line">        &quot;application/msword&quot; 1;</span><br><span class="line">        &quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot; 1;</span><br><span class="line">        &quot;application/vnd.ms-excel&quot; 1;</span><br><span class="line">        &quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot; 1;</span><br><span class="line">        &quot;application/vnd.ms-powerpoint&quot; 1;</span><br><span class="line">        &quot;application/vnd.openxmlformats-officedocument.presentationml.presentation&quot; 1;</span><br><span class="line">        &quot;text/plain&quot; 1;</span><br><span class="line">        &quot;application/rtf&quot; 1;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 视频</span></span><br><span class="line">        &quot;video/mp4&quot; 1;</span><br><span class="line">        &quot;video/x-msvideo&quot; 1;</span><br><span class="line">        &quot;video/x-ms-wmv&quot; 1;</span><br><span class="line">        &quot;video/quicktime&quot; 1;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 音频</span></span><br><span class="line">        &quot;audio/mpeg&quot; 1;</span><br><span class="line">        &quot;audio/wav&quot; 1;</span><br><span class="line">        &quot;audio/ogg&quot; 1;</span><br><span class="line">        &quot;audio/x-m4a&quot; 1;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 压缩文件</span></span><br><span class="line">        &quot;application/zip&quot; 1;</span><br><span class="line">        &quot;application/x-tar&quot; 1;</span><br><span class="line">        &quot;application/x-gzip&quot; 1;</span><br><span class="line">        &quot;application/x-7z-compressed&quot; 1;</span><br><span class="line">        &quot;application/x-rar-compressed&quot; 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> example.com;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /upload &#123;</span><br><span class="line">            <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 限制上传文件的大小为 10MB</span></span><br><span class="line">            <span class="attribute">client_max_body_size</span> <span class="number">10M</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 检查文件类型是否被允许</span></span><br><span class="line">            <span class="attribute">if</span> (<span class="variable">$allowed_type</span> = <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="attribute">return</span> <span class="number">403</span>;  <span class="comment"># 返回 403 Forbidden</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 处理文件上传的请求</span></span><br><span class="line">            <span class="attribute">proxy_pass</span> http://backend_server;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>Nginx 提供了许多内置变量，可以在配置文件中使用这些变量来控制各种行为和设置。<br>这些变量通常在日志格式、条件判断、重写规则以及反向代理配置中使用。</p>
<p>下面是一些常见的 Nginx 变量及其详细解释。</p>
<table>
<thead>
<tr>
<th>变量名</th>
<th>描述</th>
<th>示例值</th>
</tr>
</thead>
<tbody><tr>
<td><code>$host</code></td>
<td>请求中的主机头字段</td>
<td><code>example.com</code></td>
</tr>
<tr>
<td><code>$http_user_agent</code></td>
<td>客户端的 User-Agent 字段</td>
<td><code>Mozilla/5.0 (Windows NT 10.0; Win64; x64)</code></td>
</tr>
<tr>
<td><code>$http_referer</code></td>
<td>请求发起页面的 URL</td>
<td><code>https://www.google.com/</code></td>
</tr>
<tr>
<td><code>$http_cookie</code></td>
<td>客户端请求中的 Cookie 字段</td>
<td><code>sessionid=abcdef1234567890</code></td>
</tr>
<tr>
<td><code>$remote_addr</code></td>
<td>客户端 IP 地址</td>
<td><code>192.168.1.1</code></td>
</tr>
<tr>
<td><code>$remote_port</code></td>
<td>客户端端口号</td>
<td><code>54321</code></td>
</tr>
<tr>
<td><code>$server_addr</code></td>
<td>服务器 IP 地址</td>
<td><code>192.168.1.2</code></td>
</tr>
<tr>
<td><code>$server_name</code></td>
<td>服务器名称</td>
<td><code>example.com</code></td>
</tr>
<tr>
<td><code>$server_port</code></td>
<td>服务器监听端口</td>
<td><code>80</code> 或 <code>443</code></td>
</tr>
<tr>
<td><code>$uri</code></td>
<td>请求中的当前 path，不包含请求参数</td>
<td><code>/path/to/resource</code></td>
</tr>
<tr>
<td><code>$document_uri</code></td>
<td>与 <code>$uri</code> 相同</td>
<td><code>/path/to/resource</code></td>
</tr>
<tr>
<td><code>$request_uri</code></td>
<td>原始请求 path，包含请求参数</td>
<td><code>/path/to/resource?query=string</code></td>
</tr>
<tr>
<td><code>$query_string</code> 或 <code>$args</code></td>
<td>请求中的参数部分</td>
<td><code>query=string</code></td>
</tr>
<tr>
<td><code>$request_method</code></td>
<td>请求方法</td>
<td><code>GET</code>, <code>POST</code></td>
</tr>
<tr>
<td><code>$scheme</code></td>
<td>请求使用的协议</td>
<td><code>http</code>, <code>https</code></td>
</tr>
<tr>
<td><code>$status</code></td>
<td>响应状态码</td>
<td><code>200</code>, <code>404</code></td>
</tr>
<tr>
<td><code>$time_local</code></td>
<td>请求的本地时间</td>
<td><code>10/Jul/2021:15:44:35 +0800</code></td>
</tr>
<tr>
<td><code>$proxy_add_x_forwarded_for</code></td>
<td>在现有 <code>X-Forwarded-For</code> 头字段后面添加客户端 IP</td>
<td><code>192.168.1.1, 10.0.0.1</code></td>
</tr>
</tbody></table>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/04/06/hello-world/" rel="prev" title="Hello World">
                  <i class="fa fa-angle-left"></i> Hello World
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/04/07/log4j2%E9%85%8D%E7%BD%AE/" rel="next" title="log4j2配置">
                  log4j2配置 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">guodefu909</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
